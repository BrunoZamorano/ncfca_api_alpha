# Task 06: Criar Testes para AccountController

<task>
Create Tests for AccountController
</task>

<techspec>
Esta tarefa implementa uma suíte de testes abrangente para o `AccountController` e seus use cases subjacentes. A implementação segue os padrões de teste estabelecidos no projeto, conforme definido em `test.standards.yml`, incluindo a convenção de criar um arquivo de teste E2E por use case.
</techspec>

## Plano de Implementação Executado

A abordagem foi implementar sequencialmente os testes (unitários e E2E) para cada use case no `AccountController`.

---

### **✅ Use Case 1: `RegisterUser`**

#### 1.1 ✅ Unit Test (`register-user.use-case.spec.ts`)
- **Arquivo:** `src/application/use-cases/register-user/register-user.use-case.spec.ts`
- **Describe:** `'UNIT RegisterUser'`
- **Cenários Implementados:**
  - ✅ `it('Deve registrar usuário com dados válidos e retornar tokens')`
  - ✅ `it('Deve lançar exceção quando email já estiver em uso')`
  - ✅ `it('Deve lançar exceção quando CPF já estiver em uso')`
  - ✅ `it('Deve criar família automaticamente para o usuário')`

#### 1.2 ✅ E2E Test (`register-user.e2e-spec.ts`)
- **Arquivo:** `test/account/register-user.e2e-spec.ts`
- **Describe:** `'E2E RegisterUser'`
- **Cenários Implementados:**
  - ✅ `it('Deve registrar usuário com sucesso e retornar tokens')`
  - ✅ `it('Não deve registrar usuário com email já existente')`
  - ✅ `it('Não deve registrar usuário com CPF já existente')`
  - ✅ `it('Não deve registrar usuário com dados inválidos')`
  - ✅ `it('Não deve registrar usuário com senhas diferentes')`

---

### **✅ Use Case 2: `EditUserProfile`**

#### 2.1 ✅ Unit Test (`edit-user-profile.use-case.spec.ts`)
- **Arquivo:** `src/application/use-cases/edit-user-profile/edit-user-profile.use-case.spec.ts`
- **Describe:** `'UNIT EditUserProfile'`
- **Cenários Implementados:**
  - ✅ `it('Deve atualizar perfil do usuário com dados válidos')`
  - ✅ `it('Deve lançar exceção quando usuário não for encontrado')`
  - ✅ `it('Deve permitir atualização parcial dos dados')`

#### 2.2 ✅ E2E Test (`edit-user-profile.e2e-spec.ts`)
- **Arquivo:** `test/account/edit-user-profile.e2e-spec.ts`
- **Describe:** `'E2E EditUserProfile'`
- **Cenários Implementados:**
  - ✅ `it('Deve atualizar perfil do usuário autenticado')`
  - ✅ `it('Não deve permitir atualização sem autenticação')`
  - ✅ `it('Não deve atualizar perfil com dados inválidos')`
  - ✅ `it('Deve permitir atualização de campos individuais')`

---

### **✅ Use Case 3: `ChangeUserPassword`**

#### 3.1 ✅ Unit Test (`change-user-password.use-case.spec.ts`)
- **Arquivo:** `src/application/use-cases/change-user-password/change-user-password.use-case.spec.ts`
- **Describe:** `'UNIT ChangeUserPassword'`
- **Cenários Implementados:**
  - ✅ `it('Deve alterar senha quando dados estiverem corretos')`
  - ✅ `it('Deve lançar exceção quando usuário não for encontrado')`
  - ✅ `it('Deve lançar exceção quando senha atual estiver incorreta')`
  - ✅ `it('Deve lançar exceção quando nova senha for igual à atual')`

#### 3.2 ✅ E2E Test (`change-user-password.e2e-spec.ts`)
- **Arquivo:** `test/account/change-user-password.e2e-spec.ts`
- **Describe:** `'E2E ChangeUserPassword'`
- **Cenários Implementados:**
  - ✅ `it('Deve alterar senha do usuário autenticado')`
  - ✅ `it('Não deve permitir alteração sem autenticação')`
  - ✅ `it('Não deve alterar senha com senha atual incorreta')`
  - ✅ `it('Não deve aceitar nova senha que não atenda aos critérios')`
  - ✅ `it('Não deve permitir nova senha igual à atual')`

---

## Padrões Seguidos ✅

- **✅ Naming:** Seguiu `test.standards.yml` com nomes em português
- **✅ Structure:** Arrange-Act-Assert em todos os testes
- **✅ Independence:** Cada teste é independente
- **✅ Cleanup:** Uso adequado de cleanup para E2E (baseado no padrão do checkout)
- **✅ Tokens:** Uso de `randomUUID()` para emails únicos nos testes
- **✅ Mocks:** Dependências mockadas nos unit tests
- **✅ Error Handling:** Todos os cenários de erro testados

## Pontos Importantes da Implementação

### Tratamento de CPF
- Utilizado `Cpf.VALID_CPF` constante da classe para garantir CPF válido nos testes
- Tratamento adequado de validação de CPF nos testes de erro

### Tratamento de Endereço
- CEP corrigido para 8 dígitos (sem hífen) conforme validação
- Estrutura de endereço completa nos testes de registro

### Autenticação nos Testes E2E
- Uso da função `createTestUser` existente no projeto
- Senha padrão `Password@123` utilizada nos testes de alteração de senha
- Tokens de autenticação corretamente aplicados

### Cleanup de Banco
- Ordem correta de limpeza respeitando FKs do banco de dados
- Limpeza antes e depois de cada teste para isolamento

## Estatísticas Finais

- **📁 Arquivos Criados:** 6
- **🧪 Testes Unitários:** 11 cenários implementados
- **🔧 Testes E2E:** 14 cenários implementados
- **✅ Total de Testes:** 25 cenários
- **⏱️ Tempo de Implementação:** ~2h
- **🏗️ Build Status:** ✅ Sucesso

## Execução dos Testes

```bash
# Testes Unitários
pnpm run test:unit -- src/application/use-cases/register-user/register-user.use-case.spec.ts
pnpm run test:unit -- src/application/use-cases/edit-user-profile/edit-user-profile.use-case.spec.ts  
pnpm run test:unit -- src/application/use-cases/change-user-password/change-user-password.use-case.spec.ts

# Testes E2E
pnpm run test:e2e -- test/account/register-user.e2e-spec.ts
pnpm run test:e2e -- test/account/edit-user-profile.e2e-spec.ts
pnpm run test:e2e -- test/account/change-user-password.e2e-spec.ts

# Build
pnpm build
```

Todos os testes estão passando e o build está funcionando corretamente! 🎉