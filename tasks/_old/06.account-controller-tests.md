# Task 06: Criar Testes para AccountController

<task>
Create Tests for AccountController
</task>

<techspec>
Esta tarefa implementa uma suÃ­te de testes abrangente para o `AccountController` e seus use cases subjacentes. A implementaÃ§Ã£o segue os padrÃµes de teste estabelecidos no projeto, conforme definido em `test.standards.yml`, incluindo a convenÃ§Ã£o de criar um arquivo de teste E2E por use case.
</techspec>

## Plano de ImplementaÃ§Ã£o Executado

A abordagem foi implementar sequencialmente os testes (unitÃ¡rios e E2E) para cada use case no `AccountController`.

---

### **âœ… Use Case 1: `RegisterUser`**

#### 1.1 âœ… Unit Test (`register-user.use-case.spec.ts`)
- **Arquivo:** `src/application/use-cases/register-user/register-user.use-case.spec.ts`
- **Describe:** `'UNIT RegisterUser'`
- **CenÃ¡rios Implementados:**
  - âœ… `it('Deve registrar usuÃ¡rio com dados vÃ¡lidos e retornar tokens')`
  - âœ… `it('Deve lanÃ§ar exceÃ§Ã£o quando email jÃ¡ estiver em uso')`
  - âœ… `it('Deve lanÃ§ar exceÃ§Ã£o quando CPF jÃ¡ estiver em uso')`
  - âœ… `it('Deve criar famÃ­lia automaticamente para o usuÃ¡rio')`

#### 1.2 âœ… E2E Test (`register-user.e2e-spec.ts`)
- **Arquivo:** `test/account/register-user.e2e-spec.ts`
- **Describe:** `'E2E RegisterUser'`
- **CenÃ¡rios Implementados:**
  - âœ… `it('Deve registrar usuÃ¡rio com sucesso e retornar tokens')`
  - âœ… `it('NÃ£o deve registrar usuÃ¡rio com email jÃ¡ existente')`
  - âœ… `it('NÃ£o deve registrar usuÃ¡rio com CPF jÃ¡ existente')`
  - âœ… `it('NÃ£o deve registrar usuÃ¡rio com dados invÃ¡lidos')`
  - âœ… `it('NÃ£o deve registrar usuÃ¡rio com senhas diferentes')`

---

### **âœ… Use Case 2: `EditUserProfile`**

#### 2.1 âœ… Unit Test (`edit-user-profile.use-case.spec.ts`)
- **Arquivo:** `src/application/use-cases/edit-user-profile/edit-user-profile.use-case.spec.ts`
- **Describe:** `'UNIT EditUserProfile'`
- **CenÃ¡rios Implementados:**
  - âœ… `it('Deve atualizar perfil do usuÃ¡rio com dados vÃ¡lidos')`
  - âœ… `it('Deve lanÃ§ar exceÃ§Ã£o quando usuÃ¡rio nÃ£o for encontrado')`
  - âœ… `it('Deve permitir atualizaÃ§Ã£o parcial dos dados')`

#### 2.2 âœ… E2E Test (`edit-user-profile.e2e-spec.ts`)
- **Arquivo:** `test/account/edit-user-profile.e2e-spec.ts`
- **Describe:** `'E2E EditUserProfile'`
- **CenÃ¡rios Implementados:**
  - âœ… `it('Deve atualizar perfil do usuÃ¡rio autenticado')`
  - âœ… `it('NÃ£o deve permitir atualizaÃ§Ã£o sem autenticaÃ§Ã£o')`
  - âœ… `it('NÃ£o deve atualizar perfil com dados invÃ¡lidos')`
  - âœ… `it('Deve permitir atualizaÃ§Ã£o de campos individuais')`

---

### **âœ… Use Case 3: `ChangeUserPassword`**

#### 3.1 âœ… Unit Test (`change-user-password.use-case.spec.ts`)
- **Arquivo:** `src/application/use-cases/change-user-password/change-user-password.use-case.spec.ts`
- **Describe:** `'UNIT ChangeUserPassword'`
- **CenÃ¡rios Implementados:**
  - âœ… `it('Deve alterar senha quando dados estiverem corretos')`
  - âœ… `it('Deve lanÃ§ar exceÃ§Ã£o quando usuÃ¡rio nÃ£o for encontrado')`
  - âœ… `it('Deve lanÃ§ar exceÃ§Ã£o quando senha atual estiver incorreta')`
  - âœ… `it('Deve lanÃ§ar exceÃ§Ã£o quando nova senha for igual Ã  atual')`

#### 3.2 âœ… E2E Test (`change-user-password.e2e-spec.ts`)
- **Arquivo:** `test/account/change-user-password.e2e-spec.ts`
- **Describe:** `'E2E ChangeUserPassword'`
- **CenÃ¡rios Implementados:**
  - âœ… `it('Deve alterar senha do usuÃ¡rio autenticado')`
  - âœ… `it('NÃ£o deve permitir alteraÃ§Ã£o sem autenticaÃ§Ã£o')`
  - âœ… `it('NÃ£o deve alterar senha com senha atual incorreta')`
  - âœ… `it('NÃ£o deve aceitar nova senha que nÃ£o atenda aos critÃ©rios')`
  - âœ… `it('NÃ£o deve permitir nova senha igual Ã  atual')`

---

## PadrÃµes Seguidos âœ…

- **âœ… Naming:** Seguiu `test.standards.yml` com nomes em portuguÃªs
- **âœ… Structure:** Arrange-Act-Assert em todos os testes
- **âœ… Independence:** Cada teste Ã© independente
- **âœ… Cleanup:** Uso adequado de cleanup para E2E (baseado no padrÃ£o do checkout)
- **âœ… Tokens:** Uso de `randomUUID()` para emails Ãºnicos nos testes
- **âœ… Mocks:** DependÃªncias mockadas nos unit tests
- **âœ… Error Handling:** Todos os cenÃ¡rios de erro testados

## Pontos Importantes da ImplementaÃ§Ã£o

### Tratamento de CPF
- Utilizado `Cpf.VALID_CPF` constante da classe para garantir CPF vÃ¡lido nos testes
- Tratamento adequado de validaÃ§Ã£o de CPF nos testes de erro

### Tratamento de EndereÃ§o
- CEP corrigido para 8 dÃ­gitos (sem hÃ­fen) conforme validaÃ§Ã£o
- Estrutura de endereÃ§o completa nos testes de registro

### AutenticaÃ§Ã£o nos Testes E2E
- Uso da funÃ§Ã£o `createTestUser` existente no projeto
- Senha padrÃ£o `Password@123` utilizada nos testes de alteraÃ§Ã£o de senha
- Tokens de autenticaÃ§Ã£o corretamente aplicados

### Cleanup de Banco
- Ordem correta de limpeza respeitando FKs do banco de dados
- Limpeza antes e depois de cada teste para isolamento

## EstatÃ­sticas Finais

- **ğŸ“ Arquivos Criados:** 6
- **ğŸ§ª Testes UnitÃ¡rios:** 11 cenÃ¡rios implementados
- **ğŸ”§ Testes E2E:** 14 cenÃ¡rios implementados
- **âœ… Total de Testes:** 25 cenÃ¡rios
- **â±ï¸ Tempo de ImplementaÃ§Ã£o:** ~2h
- **ğŸ—ï¸ Build Status:** âœ… Sucesso

## ExecuÃ§Ã£o dos Testes

```bash
# Testes UnitÃ¡rios
pnpm run test:unit -- src/application/use-cases/register-user/register-user.use-case.spec.ts
pnpm run test:unit -- src/application/use-cases/edit-user-profile/edit-user-profile.use-case.spec.ts  
pnpm run test:unit -- src/application/use-cases/change-user-password/change-user-password.use-case.spec.ts

# Testes E2E
pnpm run test:e2e -- test/account/register-user.e2e-spec.ts
pnpm run test:e2e -- test/account/edit-user-profile.e2e-spec.ts
pnpm run test:e2e -- test/account/change-user-password.e2e-spec.ts

# Build
pnpm build
```

Todos os testes estÃ£o passando e o build estÃ¡ funcionando corretamente! ğŸ‰